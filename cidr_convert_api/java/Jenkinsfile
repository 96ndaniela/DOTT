pipeline { // start
	agent any
	environment { // starts environment: needed for sonarcloud and security without token at sight
		SONAR_TOKEN = credentials("sonarcloud")
		SONAR_MAVEN_GOAL=credentials("sonarcloud")
	} // ends environment
	stages { // start stage 
		stage('step one: building') { // build the environment only
			steps { // start steps
				dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api") { // within directory, you'll do...
					script { // start script
						sh 'pwd'
						sh 'mvn package'
						
						} // end script
					}// end in the directory
				} // end steps
			} // end stage one
		
		stage('step two: testing') { // start stage
			steps { // start steps
				dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api/") { // within directory
				sh 'mvn test'
					} // end directory
					script { // start script
					try { // specific java unit tests 
						junit 'target/surefire-reports/TEST-*.xml' // que se muestre en sonarqube	
   					} catch (Exception e) {
      					echo 'still connecting' // so it skips, because it's all a fail
  						} // close of exception
					} // end of script
				} // end of steps
			} // end stage
			stage('sonarcloud') { //start stage  
				steps { // start step
					dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api/") {
						withSonarQubeEnv('sonarcloud') 
						{ // start sqe
							sh 'mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.7.0.1746:sonar'
						} // close sqe
						} // close dir	
					timeout(time: 1, unit: 'HOURS') { // timeout
					waitForQualityGate abortPipeline: true }
					}// close steps
			} // close stage
		
			
		 
		
		stage('step four: linting') { // linting process used through org.maven.plugins, which has the Programming Mistake Detector
			steps { // start steps 
				dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api/") { // within directory
				sh 'pwd'
				sh 'mvn pmd:pmd' } // end directory
				dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api/target") { //within this directory that now has the linting report
				sh 'cat pmd.xml' }  // this part is only to show what the errors are within java itself
				} // end of steps
			} // end of stage
			
			stage('step five: deployment') { // start of stage
				steps { // start steps
					dir("/var/lib/jenkins/workspace/DOTTmultibranch_master/cidr_convert_api/java/cidr-api/") { // within directory
					sh 'echo "deployment of the cidr-api!"'
						sh 'mvn deploy'
						sh 'java -cp target/cidr-api-1.0-SNAPSHOT-jar-with-dependencies.jar com.dott.App'
					   //correr con mvn 
					} // end the directory
					
                		} // end steps
			} // end stage five
    } // end stages
} // end pipeline

